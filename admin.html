<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸŒ± HydroLeaf Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f7f9fc;
    }

    .card-img-top {
      object-fit: cover;
      height: 200px;
    }

    .tabSection {
      padding: 1rem;
    }

    .nav-link {
      cursor: pointer;
    }
  </style>
</head>

<body class="p-4">
  <div class="container" style="max-width:1200px;">
    <h2 class="mb-4 text-center">HydroLeaf Admin Dashboard</h2>

    <!-- LOGIN -->
    <div id="loginSection" class="card p-4 mx-auto" style="max-width:400px;">
      <div class="mb-3">
        <label for="userInput" class="form-label">Email</label>
        <input type="email" id="userInput" class="form-control" placeholder="you@example.com">
      </div>
      <div class="mb-3">
        <label for="passInput" class="form-label">Password</label>
        <input type="password" id="passInput" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button id="loginBtn" class="btn btn-primary w-100">Log In</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <strong id="welcomeMsg"></strong>
        <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Logout</button>
      </div>

      <!-- TABS -->
      <ul class="nav nav-tabs" id="adminTabs">
        <li class="nav-item"><a class="nav-link active" data-section="streamSection">Camera Stream</a></li>
        <li class="nav-item"><a class="nav-link" data-section="clipsSection">Clips</a></li>
        <li class="nav-item"><a class="nav-link" data-section="usersSection">Users</a></li>
        <li class="nav-item"><a class="nav-link" data-section="activationSection">Device Keys</a></li>
        <li class="nav-item"><a class="nav-link" data-section="cloudKeySection">Cloud Key</a></li>
        <li class="nav-item"><a class="nav-link" data-section="devicesSection">Connected Devices</a></li>
        <li class="nav-item"><a class="nav-link" data-section="cameraListSection">Cameras</a></li>
      </ul>

      <!-- CAMERA STREAM -->
      <div id="streamSection" class="tabSection">
        <div class="row g-2 mb-3">
          <div class="col-md-8">
            <input type="text" id="cameraIdsInput" class="form-control"
              placeholder="Enter up to 6 Camera IDs (comma, space or newline separated)">
          </div>
          <div class="col-md-2">
            <button id="startStreamBtn" class="btn btn-success w-100">Start Streams</button>
          </div>
          <div class="col-md-2">
            <button id="stopStreamBtn" class="btn btn-danger w-100">Stop Streams</button>
          </div>
        </div>
        <div id="streamsContainer" class="row g-3"></div>
      </div>

      <!-- CLIPS -->
      <div id="clipsSection" class="tabSection d-none">
        <div class="row g-2 mb-3">
          <div class="col-md-8">
            <input type="text" id="clipsCameraInput" class="form-control" placeholder="Camera ID e.g. CAM_1234">
          </div>
          <div class="col-md-4">
            <button id="loadClipsBtn" class="btn btn-primary w-100">Load Clips</button>
          </div>
        </div>
        <div id="clipsListContainer"></div>
      </div>

      <!-- USERS -->
      <div id="usersSection" class="tabSection d-none">
        <button id="refreshUsersBtn" class="btn btn-outline-primary mb-3">Refresh Users</button>
        <div id="usersTableContainer"></div>
      </div>

      <!-- DEVICE ACTIVATION KEY -->
      <div id="activationSection" class="tabSection d-none">
        <div class="row g-2 mb-2">
          <div class="col"><input type="text" id="actDeviceId" class="form-control" placeholder="Device ID"></div>
          <div class="col"><input type="number" id="actPlanId" class="form-control" placeholder="Plan ID"></div>
          <div class="col-auto"><button id="genActKeyBtn" class="btn btn-primary">Generate Key</button></div>
        </div>
        <pre id="actKeyResult"></pre>
      </div>

      <!-- CLOUD KEY -->
      <div id="cloudKeySection" class="tabSection d-none">
        <button id="genCloudKeyBtn" class="btn btn-primary mb-2">Generate Cloud Key</button>
        <pre id="cloudKeyResult"></pre>
      </div>

      <!-- CONNECTED DEVICES -->
      <div id="devicesSection" class="tabSection d-none">
        <button id="refreshDevicesBtn" class="btn btn-outline-primary mb-3">Refresh Devices</button>
        <div id="devicesTableContainer"></div>
      </div>

      <!-- CAMERA LIST -->
      <div id="cameraListSection" class="tabSection d-none">
        <button id="loadCameraListBtn" class="btn btn-outline-primary mb-3">Load Cameras</button>
        <div id="cameraListContainer"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
  <script>
    const baseUrl = 'http://cloud.hydroleaf.in';
    const el = id => document.getElementById(id);
    let jwtToken = '';
    const streamIntervals = {};

    // â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el('loginBtn').onclick = async () => {
      const email = el('userInput').value.trim();
      const pass = el('passInput').value;
      if (!email || !pass) return alert('Enter email & password');
      try {
        const params = new URLSearchParams({ username: email, password: pass });
        const { data } = await axios.post(`${baseUrl}/api/v1/auth/login`, params, {
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        });
        jwtToken = data.access_token;
        axios.defaults.headers.common['Authorization'] = `Bearer ${jwtToken}`;
        el('loginSection').classList.add('d-none');
        el('dashboard').classList.remove('d-none');
        el('welcomeMsg').textContent = `Logged in as ${email}`;
      } catch (err) {
        alert('Login failed: ' + (err.response?.data?.detail || err.message));
      }
    };
    el('logoutBtn').onclick = () => location.reload();

    // â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showSection(secId) {
      document.querySelectorAll('#adminTabs .nav-link').forEach(l =>
        l.classList.toggle('active', l.dataset.section === secId)
      );
      document.querySelectorAll('.tabSection').forEach(s =>
        s.id === secId ? s.classList.remove('d-none') : s.classList.add('d-none')
      );
    }
    document.querySelectorAll('#adminTabs .nav-link').forEach(link => {
      link.onclick = () => {
        const sec = link.dataset.section;
        showSection(sec);
        if (sec === 'usersSection') loadUsers();
        if (sec === 'devicesSection') loadDevices();
        if (sec === 'cameraListSection') loadCameraList();
      };
    });

    // â”€â”€â”€ STREAMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el('startStreamBtn').onclick = () => {
      Object.values(streamIntervals).forEach(clearInterval);
      Object.keys(streamIntervals).forEach(key => delete streamIntervals[key]);
      el('streamsContainer').innerHTML = '';

      const raw = el('cameraIdsInput').value.trim();
      const ids = raw.split(/[,\s;]+/).map(i => i.trim()).filter(Boolean).slice(0, 6);
      if (!ids.length) return alert('Enter at least one Camera ID (max 6).');

      ids.forEach(id => {
        const col = document.createElement('div');
        col.className = 'col-sm-6 col-md-4';
        const card = document.createElement('div');
        card.className = 'card';
        const hdr = document.createElement('div');
        hdr.className = 'card-header';
        hdr.textContent = id;
        const img = document.createElement('img');
        img.className = 'card-img-top';
        img.src = `${baseUrl}/api/v1/cameras/stream/${encodeURIComponent(id)}`;
        card.append(hdr, img);
        col.append(card);
        el('streamsContainer').append(col);
      });
    };
    el('stopStreamBtn').onclick = () => {
      Object.values(streamIntervals).forEach(clearInterval);
      Object.keys(streamIntervals).forEach(k => delete streamIntervals[k]);
      el('streamsContainer').innerHTML = '';
    };

    // â”€â”€â”€ CLIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el('loadClipsBtn').onclick = async () => {
      const cam = el('clipsCameraInput').value.trim();
      if (!cam) return alert('Enter Camera ID');
      try {
        const { data } = await axios.get(`${baseUrl}/admin/cameras/${encodeURIComponent(cam)}/clips`);
        if (!data.length) {
          el('clipsListContainer').innerHTML = '<p>No clips found</p>';
          return;
        }
        const rows = data.map(c => `
          <tr>
            <td>${c.filename}</td>
            <td>${new Date(c.datetime).toLocaleString()}</td>
            <td class="text-end">${c.size_mb}&nbsp;MB</td>
            <td class="text-nowrap">
              <a class="btn btn-sm btn-outline-success me-1" href="${baseUrl}/admin/cameras/${encodeURIComponent(cam)}/clips/${encodeURIComponent(c.filename)}/play" target="_blank">Play</a>
              <a class="btn btn-sm btn-outline-primary" href="${baseUrl}/admin/cameras/${encodeURIComponent(cam)}/clips/${encodeURIComponent(c.filename)}/download" target="_blank">Download</a>
            </td>
          </tr>
        `).join('');
        el('clipsListContainer').innerHTML = `
          <table class="table table-striped table-hover">
            <thead class="table-light">
              <tr>
                <th>Filename</th><th>Date / Time</th><th class="text-end">Size</th><th>Actions</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      } catch (e) {
        alert('Failed to load clips: ' + (e.response?.data?.detail || e.message));
      }
    };

    // â”€â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el('refreshUsersBtn').onclick = loadUsers;
    async function loadUsers() {
      try {
        const { data } = await axios.get(`${baseUrl}/admin/users`);
        if (!data.length) {
          el('usersTableContainer').innerHTML = '<p>No users found.</p>';
          return;
        }
        const rows = data.map(u => `
          <tr>
            <td>${u.id}</td><td>${u.email}</td><td>${u.role}</td>
            <td>${new Date(u.created_at).toLocaleString()}</td>
            <td>
              <button class="btn btn-sm btn-secondary me-1" onclick="impersonate(${u.id}, '${u.email}')">Impersonate</button>
              <button class="btn btn-sm btn-warning me-1" onclick="editUser(${u.id}, '${u.email}', '${u.role}')">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Delete</button>
            </td>
          </tr>
        `).join('');
        el('usersTableContainer').innerHTML = `
          <table class="table table-striped">
            <thead><tr><th>ID</th><th>Email</th><th>Role</th><th>Created At</th><th>Actions</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      } catch (e) {
        alert('Failed to load users: ' + (e.response?.data?.detail || e.message));
      }
    }

    window.impersonate = async (id, email) => {
      if (!confirm(`Impersonate ${email}?`)) return;
      try {
        const { data } = await axios.post(`${baseUrl}/admin/users/impersonate/${id}`);
        jwtToken = data.access_token;
        axios.defaults.headers.common['Authorization'] = `Bearer ${jwtToken}`;
        el('welcomeMsg').textContent = `Impersonated ${data.impersonated_user}`;
        loadUsers();
      } catch (e) {
        alert('Impersonation failed: ' + (e.response?.data?.detail || e.message));
      }
    };

    window.editUser = async (id, email, role) => {
      const ne = prompt('New email:', email);
      if (ne === null) return;
      const nr = prompt('New role:', role);
      if (nr === null) return;
      try {
        await axios.put(`${baseUrl}/admin/users/${id}`, { email: ne, role: nr });
        loadUsers();
      } catch (e) {
        alert('Update failed: ' + (e.response?.data?.detail || e.message));
      }
    };

    window.deleteUser = async id => {
      if (!confirm(`Delete user ${id}?`)) return;
      try {
        await axios.delete(`${baseUrl}/admin/users/${id}`);
        loadUsers();
      } catch (e) {
        alert('Delete failed: ' + (e.response?.data?.detail || e.message));
      }
    };

    // â”€â”€â”€ DEVICE KEYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el('genActKeyBtn').onclick = async () => {
      const dev = el('actDeviceId').value.trim();
      const pl = el('actPlanId').value.trim();
      if (!dev || !pl) return alert('Enter device & plan IDs');
      try {
        const { data } = await axios.post(`${baseUrl}/admin/generate_device_activation_key`, null, { params: { device_id: dev, plan_id: pl } });
        el('actKeyResult').textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        alert('Error: ' + (e.response?.data?.detail || e.message));
      }
    };

    // â”€â”€â”€ CLOUD KEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el('genCloudKeyBtn').onclick = async () => {
      try {
        const { data } = await axios.post(`${baseUrl}/api/v1/cloud/admin/generate_cloud_key`);
        el('cloudKeyResult').textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        alert('Error: ' + (e.response?.data?.detail || e.message));
      }
    };

    // â”€â”€â”€ DEVICES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el('refreshDevicesBtn').onclick = loadDevices;
    async function loadDevices() {
      try {
        const { data } = await axios.get(`${baseUrl}/admin/devices`);
        if (!Object.keys(data).length) {
          el('devicesTableContainer').innerHTML = '<p>No connected devices.</p>';
          return;
        }
        const rows = Object.entries(data).map(([id, info]) => `
          <tr>
            <td>${id}</td><td>${info.ip}</td><td>${info.reachable}</td><td>${new Date(info.last_seen * 1000).toLocaleString()}</td>
          </tr>
        `).join('');
        el('devicesTableContainer').innerHTML = `
          <table class="table table-bordered">
            <thead><tr><th>Device ID</th>\<th>IP<\/th>\<th>Reachable<\/th>\<th>Last Seen<\/th><\/tr><\/thead>
            <tbody>${rows}<\/tbody>
          <\/table>
        `;
      } catch (e) {
        alert('Error: ' + (e.response?.data?.detail || e.message));
      }
    }

    // â”€â”€â”€ CAMERA LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el('loadCameraListBtn').onclick = loadCameraList;
    async function loadCameraList() {
      try {
        const { data } = await axios.get(`${baseUrl}/admin/cameras/list`);
        if (!data.length) {
          el('cameraListContainer').innerHTML = '<p>No cameras found.</p>';
          return;
        }
        const rows = data.map(c => `
          <tr>
            <td>${c.camera_id}</td><td>${c.is_online}</td><td>${new Date(c.last_seen).toLocaleString()}</td><td>${c.frames_received}</td><td>${c.clips_count}</td>
          </tr>
        `).join('');
        el('cameraListContainer').innerHTML = `
          <table class="table table-bordered">
            <thead><tr><th>Camera ID</th><th>Online</th><th>Last Seen</th><th>Frames</th><th>Clips</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      } catch (e) {
        alert('Failed to load cameras: ' + (e.response?.data?.detail || e.message));
      }
    }
  </script>
</body>

</html>
