<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ðŸŒ± HydroLeaf Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f0f2f5;
    }

    .tab-section {
      display: none;
      padding: 1rem;
    }

    .tab-section.active {
      display: block;
    }

    .card-img-top {
      object-fit: cover;
      height: 180px;
    }

    pre {
      background: #fff;
      padding: .75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="container my-4" style="max-width: 1200px;">
    <h2 class="text-center mb-4">HydroLeaf Admin</h2>

    <!-- Login -->
    <div id="login-card" class="card mx-auto p-4" style="max-width: 360px;">
      <h5 class="card-title mb-3">Admin Log In</h5>
      <div class="mb-3">
        <label for="login-email" class="form-label">Email</label>
        <input id="login-email" type="email" class="form-control" placeholder="admin@hydroleaf.in">
      </div>
      <div class="mb-3">
        <label for="login-pass" class="form-label">Password</label>
        <input id="login-pass" type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button id="btn-login" class="btn btn-primary w-100">Log In</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 id="welcome-msg"></h5>
        <button id="btn-logout" class="btn btn-outline-secondary btn-sm">Logout</button>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="tabs">
        <li class="nav-item"><button class="nav-link active" data-target="stream-section">Streams</button></li>
        <li class="nav-item"><button class="nav-link" data-target="clips-section">Clips</button></li>
        <li class="nav-item"><button class="nav-link" data-target="users-section">Users</button></li>
        <li class="nav-item"><button class="nav-link" data-target="activation-section">Device Keys</button></li>
        <li class="nav-item"><button class="nav-link" data-target="cloudkey-section">Cloud Key</button></n <li
            class="nav-item"><button class="nav-link" data-target="devices-section">My Devices</button></li>
        <li class="nav-item"><button class="nav-link" data-target="alldevices-section">All Devices</button></li>
        <li class="nav-item"><button class="nav-link" data-target="authdevices-section">Authenticated Devices</button>
        </li>
        <li class="nav-item"><button class="nav-link" data-target="cameras-section">Cameras</button></li>
        <li class="nav-item"><button class="nav-link" data-target="toggleswitch-section">Toggle Switch</button></li>
      </ul>

      <!-- Stream Section -->
      <div id="stream-section" class="tab-section active">
        <div class="input-group mb-3">
          <input id="stream-ids" type="text" class="form-control" placeholder="Camera IDs (comma-separated, up to 6)">
          <button id="btn-start-stream" class="btn btn-success">Start</button>
          <button id="btn-stop-stream" class="btn btn-danger">Stop</button>
        </div>
        <div id="stream-container" class="row g-3"></div>
      </div>

      <!-- Clips Section -->
      <div id="clips-section" class="tab-section">
        <div class="input-group mb-3">
          <input id="clips-cam-id" type="text" class="form-control" placeholder="Camera ID">
          <button id="btn-load-clips" class="btn btn-primary">Load Clips</button>
        </div>
        <div id="clips-container"></div>
      </div>

      <!-- Users Section -->
      <div id="users-section" class="tab-section">
        <button id="btn-refresh-users" class="btn btn-outline-primary mb-3">Refresh Users</button>
        <div id="users-container"></div>
      </div>

      <!-- Activation Section -->
      <div id="activation-section" class="tab-section">
        <div class="row g-2 align-items-center mb-2">
          <div class="col"><input id="act-cam-id" type="text" class="form-control" placeholder="Device ID"></div>
          <div class="col"><input id="act-plan-id" type="number" class="form-control" placeholder="Plan ID"></div>
          <div class="col-auto"><button id="btn-gen-activation" class="btn btn-primary">Generate</button></div>
        </div>
        <pre id="activation-result">â€”</pre>
      </div>

      <!-- Cloud Key Section -->
      <div id="cloudkey-section" class="tab-section">
        <button id="btn-gen-cloudkey" class="btn btn-primary me-2">Generate Key</button>
        <button id="btn-list-cloudkeys" class="btn btn-outline-secondary me-2">List Keys</button>
        <button id="btn-list-usage" class="btn btn-outline-secondary">List Usages</button>
        <pre id="cloudkey-result" class="mt-3">â€”</pre>
      </div>

      <!-- My Devices Section -->
      <div id="devices-section" class="tab-section">
        <button id="btn-refresh-devices" class="btn btn-outline-primary mb-3">Refresh My Devices</button>
        <div id="my-devices-container"></div>
      </div>

      <!-- All Devices Section -->
      <div id="alldevices-section" class="tab-section">
        <button id="btn-load-alldevices" class="btn btn-outline-primary mb-3">Load All Devices</button>
        <div id="all-devices-container"></div>
      </div>

      <!-- Authenticated Devices Section -->
      <div id="authdevices-section" class="tab-section">
        <button id="btn-load-authdevices" class="btn btn-outline-primary mb-3">Load Authenticated Devices</button>
        <pre id="authdevices-result">â€”</pre>
      </div>

      <!-- Cameras Section -->
      <div id="cameras-section" class="tab-section">
        <button id="btn-load-cameras" class="btn btn-outline-primary mb-3">Load Cameras</button>
        <div id="cameras-container"></div>
      </div>

      <!-- Toggle Switch Section -->
      <div id="toggleswitch-section" class="tab-section">
        <div class="row g-2 mb-3">
          <div class="col-md-4"><input id="switch-dev-id" type="text" class="form-control" placeholder="Device ID">
          </div>
          <div class="col-md-4"><input id="switch-token" type="text" class="form-control" placeholder="Bearer Token">
          </div>
          <div class="col-md-4"><button id="btn-load-switch" class="btn btn-outline-primary w-100">Load State</button>
          </div>
        </div>
        <pre id="switch-state">â€”</pre>
        <div class="row g-2 mt-3">
          <div class="col-md-4"><input id="switch-channel" type="number" class="form-control" min="1" max="8"
              placeholder="Channel"></div>
          <div class="col-md-4"><button id="btn-toggle-switch" class="btn btn-primary w-100">Toggle</button></div>
        </div>
        <pre id="switch-result" class="mt-2">â€”</pre>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
  <script defer>
    (function () {
      const base = location.origin;
      let token = '';
      const api = axios.create({ baseURL: base });

      // Auth
      const loginCard = document.getElementById('login-card');
      const dashboard = document.getElementById('dashboard');
      const welcomeMsg = document.getElementById('welcome-msg');

      async function doLogin() {
        const email = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-pass').value;
        if (!email || !pass) return alert('Email & password required');
        try {
          const params = new URLSearchParams({ grant_type: 'password', username: email, password: pass });
          const res = await api.post('/api/v1/auth/login', params, { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } });
          token = res.data.access_token;
          api.defaults.headers.common['Authorization'] = 'Bearer ' + token;
          loginCard.classList.add('d-none');
          dashboard.classList.remove('d-none');
          welcomeMsg.textContent = `Welcome, ${email}`;
        } catch (err) {
          alert('Login failed: ' + (err.response?.data?.detail || err.message));
        }
      }
      document.getElementById('btn-login').addEventListener('click', doLogin);
      document.getElementById('btn-logout').addEventListener('click', () => location.reload());

      // Tabs
      document.querySelectorAll('#tabs .nav-link').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('#tabs .nav-link').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
          const tgt = document.getElementById(tab.dataset.target);
          tgt && tgt.classList.add('active');
          // Auto-load
          switch (tab.dataset.target) {
            case 'users-section': loadUsers(); break;
            case 'stream-section': break;
            case 'activation-section': break;
            case 'cloudkey-section': break;
            case 'devices-section': loadMyDevices(); break;
            case 'alldevices-section': loadAllDevices(); break;
            case 'authdevices-section': loadAuthDevices(); break;
            case 'cameras-section': loadCameras(); break;
          }
        });
      });

      // Stream
      let streamIntervals = {};
      document.getElementById('btn-start-stream').addEventListener('click', () => {
        const ids = document.getElementById('stream-ids').value.split(',').map(s => s.trim()).filter(Boolean).slice(0, 6);
        const container = document.getElementById('stream-container'); container.innerHTML = '';
        ids.forEach(id => {
          const col = document.createElement('div'); col.className = 'col-md-4';
          const card = document.createElement('div'); card.className = 'card';
          const hdr = document.createElement('div'); hdr.className = 'card-header'; hdr.textContent = id;
          const img = document.createElement('img'); img.className = 'card-img-top';
          card.append(hdr, img); col.append(card); container.append(col);
          streamIntervals[id] = setInterval(async () => {
            try {
              const resp = await api.get(`/api/v1/cameras/stream/${encodeURIComponent(id)}?mode=poll`, { responseType: 'blob' });
              img.src = URL.createObjectURL(resp.data);
            } catch { };
          }, 2000);
        });
      });
      document.getElementById('btn-stop-stream').addEventListener('click', () => {
        Object.values(streamIntervals).forEach(clearInterval);
        document.getElementById('stream-container').innerHTML = '';
      });

      // Clips
      document.getElementById('btn-load-clips').addEventListener('click', async () => {
        const cam = document.getElementById('clips-cam-id').value.trim();
        if (!cam) return alert('Camera ID required');
        try {
          const { data } = await api.get(`/admin/cameras/${encodeURIComponent(cam)}/clips`);
          const tbl = data.length ? `<table class="table"><thead><tr><th>File</th><th>Date</th><th>Size</th><th></th></tr></thead><tbody>${data.map(c => `<tr><td>${c.filename}</td><td>${new Date(c.datetime).toLocaleString()}</td><td>${c.size_mb}MB</td><td>` +
            `<button class="btn btn-sm btn-success me-1" onclick="play('${cam}','${c.filename}')">Play</button>` +
            `<a class="btn btn-sm btn-outline-primary" href="${base}/admin/cameras/${cam}/clips/${c.filename}/download" target="_blank">Download</a>` +
            `</td></tr>`).join('')
            }</tbody></table>` : '<p>No clips found.</p>';
          document.getElementById('clips-container').innerHTML = tbl;
        } catch (err) { alert('Error loading clips: ' + (err.response?.data?.detail || err.message)); }
      });
      window.play = async (cam, file) => {
        try {
          const { data } = await api.get(`/admin/cameras/${encodeURIComponent(cam)}/clips/${encodeURIComponent(file)}/download`, { responseType: 'blob' });
          const url = URL.createObjectURL(data);
          const modalHtml = `<div class="modal fade" tabindex="-1" id="clipModal"><div class="modal-dialog modal-xl"><div class="modal-content">` +
            `<div class="modal-header"><h5 class="modal-title">${file}</h5>` +
            `<button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>` +
            `<div class="modal-body"><video controls src="${url}" style="width:100%"></video></div>` +
            `</div></div></div>`;
          document.body.insertAdjacentHTML('beforeend', modalHtml);
          const modal = new bootstrap.Modal(document.getElementById('clipModal')); modal.show();
          document.getElementById('clipModal').addEventListener('hidden.bs.modal', () => {
            URL.revokeObjectURL(url); document.getElementById('clipModal').remove();
          });
        } catch (err) { alert('Failed to play: ' + err.message); }
      };

      // Users
      async function loadUsers() {
        try {
          const { data } = await api.get('/admin/users');
          const html = data.length ? `<table class="table"><thead><tr><th>ID</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody>${data.map(u => `<tr><td>${u.id}</td><td>${u.email}</td><td>${u.role}</td><td>` +
            `<button class="btn btn-sm btn-warning me-1" onclick="editUser(${u.id})">Edit</button>` +
            `<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Delete</button>` +
            `</td></tr>`).join('')
            }</tbody></table>` : '<p>No users.</p>';
          document.getElementById('users-container').innerHTML = html;
        } catch (err) { alert('Error loading users:' + err.message); }
      }
      document.getElementById('btn-refresh-users').addEventListener('click', loadUsers);
      window.editUser = async id => {
        const email = prompt('New email'), role = prompt('New role');
        if (email != null && role != null) await api.put(`/admin/users/${id}`, { email, role }); loadUsers();
      };
      window.deleteUser = async id => { if (confirm('Delete user?')) { await api.delete(`/admin/users/${id}`); loadUsers(); } };

      // Activation Key
      document.getElementById('btn-gen-activation').addEventListener('click', async () => {
        const dev = document.getElementById('act-cam-id').value.trim(), plan = document.getElementById('act-plan-id').value.trim();
        if (!dev || !plan) return alert('Device ID & Plan ID');
        try {
          const { data } = await api.post('/admin/generate_device_activation_key', null, { params: { device_id: dev, plan_id: plan } });
          document.getElementById('activation-result').textContent = JSON.stringify(data, null, 2);
        } catch (err) { alert(err.message); }
      });

      // Cloud Key
      document.getElementById('btn-gen-cloudkey').addEventListener('click', async () => {
        try {
          const { data } = await api.post('/api/v1/cloud/admin/generate_cloud_key');
          document.getElementById('cloudkey-result').textContent = JSON.stringify(data, null, 2);
        } catch (err) { alert(err); }
      });
      document.getElementById('btn-list-cloudkeys').addEventListener('click', async () => {
        try {
          const { data } = await api.get('/api/v1/cloud/admin/cloud-keys');
          document.getElementById('cloudkey-result').textContent = JSON.stringify(data, null, 2);
        } catch (err) { alert(err); }
      });
      document.getElementById('btn-list-usage').addEventListener('click', async () => {
        try {
          const { data } = await api.get('/api/v1/cloud/admin/cloud_key_usages');
          document.getElementById('cloudkey-result').textContent = JSON.stringify(data, null, 2);
        } catch (err) { alert(err); }
      });

      // My Devices
      async function loadMyDevices() {
        const out = document.getElementById('my-devices-container'); out.innerHTML = '';
        const endpoints = ['/admin/devices/dosing', '/admin/devices/valves', '/admin/devices/switches'];
        for (let ep of endpoints) {
          try {
            const { data } = await api.get(ep);
            if (data.length) {
              const rows = data.map(d => `<tr><td>${d.id}</td><td>${d.name}</td><td>${d.type}</td><td>${d.http_endpoint}</td></tr>`).join('');
              out.insertAdjacentHTML('beforeend', `<h6>${ep.split('/').pop().toUpperCase()}</h6>` +
                `<table class="table"><thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Endpoint</th></tr></thead><tbody>${rows}</tbody></table>`);
            }
          } catch { };
        }
      }
      document.getElementById('btn-refresh-devices').addEventListener('click', loadMyDevices);

      // All Devices
      document.getElementById('btn-load-alldevices').addEventListener('click', async () => {
        try {
          const { data } = await api.get('/admin/devices/all');
          const c = document.getElementById('all-devices-container');
          c.innerHTML = data.length ?
            `<table class="table"><thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Endpoint</th></tr></thead><tbody>${data.map(d => `<tr><td>${d.id}</td><td>${d.name}</td><td>${d.type}</td><td>${d.http_endpoint}</td></tr>`).join('')
            }</tbody></table>` : '<p>No devices.</p>';
        } catch (err) { alert(err); }
      });

      // Authenticated Devices
      document.getElementById('btn-load-authdevices').addEventListener('click', async () => {
        try {
          const { data } = await api.get('/admin/devices/authenticated');
          document.getElementById('authdevices-result').textContent = JSON.stringify(data, null, 2);
        } catch (err) { alert(err); }
      });

      // Cameras
      async function loadCameras() {
        try {
          const { data } = await api.get('/admin/cameras/list');
          const c = document.getElementById('cameras-container'); c.innerHTML = '';
          if (data.length) data.forEach(cam => c.insertAdjacentHTML('beforeend', `<p>${cam.camera_id} â€” ${cam.detections.length} events</p>`));
          else c.innerHTML = '<p>No cameras.</p>';
        } catch (err) { alert(err); }
      }
      document.getElementById('btn-load-cameras').addEventListener('click', loadCameras);

      // Toggle Switch
      document.getElementById('btn-load-switch').addEventListener('click', async () => {
        const dev = document.getElementById('switch-dev-id').value.trim();
        const tok = document.getElementById('switch-token').value.trim();
        if (!dev || !tok) return alert('Device & token');
        try {
          const { data } = await api.get(`/api/v1/device_comm/switch/${encodeURIComponent(dev)}/state`, { headers: { Authorization: 'Bearer ' + tok } });
          document.getElementById('switch-state').textContent = JSON.stringify(data, null, 2);
        } catch (err) { alert(err); }
      });
      document.getElementById('btn-toggle-switch').addEventListener('click', async () => {
        const dev = document.getElementById('switch-dev-id').value.trim();
        const tok = document.getElementById('switch-token').value.trim();
        const ch = document.getElementById('switch-channel').value;
        if (!dev || !tok || !ch) return alert('All fields');
        try {
          const { data } = await api.post(`/api/v1/device_comm/switch/${encodeURIComponent(dev)}/toggle`, { channel: parseInt(ch) },
            { headers: { Authorization: 'Bearer ' + tok } });
          document.getElementById('switch-result').textContent = JSON.stringify(data, null, 2);
        } catch (err) { alert(err); }
      });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
</body>

</html>